<!doctype html>
<html>
 <head>
  <title>Beagle, version 0.01</title>
  <meta content="An interactive environment for learning about programming" name="description" />
  <meta content="Lisp, programming" name="keywords" />
  <meta content="Matt Fenwick" name="author" />
  <link href="style.css" rel="stylesheet" type="text/css" />

  <script type="text/javascript" src="jquery1.7.2.js"></script>
  <script type="text/javascript" src="underscore1.3.3.js"></script>
  <script type="text/javascript" src="backbone0.9.2.js"></script>

  <script type="text/javascript" src="../javascript/maybeerror.js"></script>
  <script type="text/javascript" src="../javascript/tokens.js"></script>
  <script type="text/javascript" src="../javascript/tokenizer.js"></script>
  <script type="text/javascript" src="../javascript/parsercombs.js"></script>
  <script type="text/javascript" src="../javascript/ast.js"></script>
  <script type="text/javascript" src="../javascript/parser.js"></script>
  <script type="text/javascript" src="../javascript/environment.js"></script>
  <script type="text/javascript" src="../javascript/data.js"></script>
  <script type="text/javascript" src="../javascript/functions.js"></script>
  <script type="text/javascript" src="../javascript/evaluate.js"></script>
  <script type="text/javascript" src="../javascript/beagle.js"></script>
  
  <script type="text/javascript" src="repl.js"></script>
 </head>
 <body>

  <div id="container">
   
   <div id="left">
    <div>Expression history</div>
    <ul id="history"></ul>

    <div id="current">
     <div>Enter an expression for evaluation here (press enter to evaluate it):</div>
     <textarea id="expr"></textarea>
    </div>
   </div>
  
   <div id="right">
    <div id="envcontainer">
     <div>This is the current top-level environment:</div>
     <table id="env">
      <tr><th>name</th><th>type</th><th>value</th></tr>
     </table>
    </div>
    
    <div>
     <div>tokenization of last expression:</div>
     <div id="lastsexpr"></div>
     <div>AST of last parse:</div>
     <div id="lastprims"></div>
    </div>
   </div>
   
  </div>


 <script type="text/javascript">

function isString(obj) {
  if(obj.type !== 'list') {
    return false;
  }
  return obj.value.every(function(c) {return c.type === 'char';});
}
 

function printer(obj) {
  if(isString(obj)) {
    return '"' + obj.value.map(function(c) {return c.value;}).join('') + '"';
  }
  
  if( obj.type === 'function' ) {
    return '<function>';
  }
  
  if( obj.type === 'null' ) {
    return '<null>';
  }
  
  if( obj.type === 'symbol' ) {
    return "'" + obj.value;
  }
  
  if( obj.type === 'object' ) {
    return JSON.stringify(obj.value); // um, should probably change this to be recursive
  }
  
  if( obj.type === 'error' ) {
    return "error: [" + printer(obj.value) + "]";
  }
  
  if( obj.type === 'list' ) {
    return obj.value.map(printer);
  }
  
  if( obj.type === 'char' ) {
    return "'" + obj.value + "'";
  }
  
  if( obj.type === 'boolean' ) {
    return obj.value;
  }
  
  if( obj.type === 'number' ) {
    return obj.value;
  }

  return obj;
}


function displayEnv(envi) {
  var tab = $("#env"),
      q, val;
  $("#env .envrow").remove();
  for(q in envi._bindings) {
    val = envi.getBinding(q);
    tab.append('<tr class="envrow"><td>' + q + "</td><td>" + val.type + "</td><td>" + _.escape(printer(val)) + "</td></tr>");
  }
}


 $(document).ready(function() {

  var evaler = new Repl.Evaluator(),
      env = evaler.getEnvironment();

  //$("#runner").click(function(e) { //
  $("#expr").bind('keydown', function(e) {
    var code = (e.keyCode ? e.keyCode : e.which);
    if( code == 13 ) {
      var str = $("#expr").val();
      evaler.evalString(str); // which then runs the lisper, calls listeners ...
      return false;
    }
    return true;
  });

  evaler.bind("success", function(obj) {
      var h = $("#history");
      h.append("<li><pre>" + _.escape("> " + obj.input) + "</pre></li>");
      // remember -- only allowing one form (for now) so just take the first
      obj.results.map(function(x) {
          h.append("<li>" + _.escape(JSON.stringify(printer(x))) + "</li>");
      });
  });
  
  evaler.bind("success", function(obj) {
      displayEnv(env);
      $("#lastsexpr").text(JSON.stringify(obj.tokens));
      $("#lastprims").text(JSON.stringify(obj.asts) + "<br />" + JSON.stringify(obj.results[0]));
      $("#expr").val(""); // clear the input area
  });

  evaler.bind("error", function(obj) {
      var h = $("#history"),
          sed = JSON.stringify(obj);
      h.append("<li><pre>" + _.escape("> " + obj.input) + "</pre></li>");
      h.append("<li>" + "ERROR: " + _.escape(sed) + "</li>"); // TODO need to stabilize up error interface to provide better messages
  });
  
  evaler.bind('all', function() {
      var h = $("#history");
      h.scrollTop(h.prop("scrollHeight"));
  });

  // get the page set-up:  show the environment
  displayEnv(env);

 });

</script>

 </body>
</html>