<!doctype html>
<html>
 <head>
  <title>My programming language, version 0.01</title>
  <meta content="An interactive environment for learning about programming" name="description" />
  <meta content="Lisp, programming" name="keywords" />
  <meta content="Matt Fenwick" name="author" />
  <link href="style.css" rel="stylesheet" type="text/css" />

  <script type="text/javascript" src="jquery1.7.2.js"></script>
  <script type="text/javascript" src="underscore1.3.3.js"></script>
  <script type="text/javascript" src="backbone0.9.2.js"></script>

  <script type="text/javascript" src="../javascript/data.js"></script>
  <script type="text/javascript" src="../javascript/functions.js"></script>
  <script type="text/javascript" src="../javascript/evaluate.js"></script>
  <script type="text/javascript" src="../javascript/parse.js"></script>
  <script type="text/javascript" src="../javascript/beagle.js"></script>
  
  <script type="text/javascript" src="../javascript/loader.js"></script>

  <script type="text/javascript" src="repl.js"></script>
 </head>
 <body>

  <div id="container">
   
   <div id="left">
    <div>Expression history</div>
    <ul id="history"></ul>

    <div id="current">
     <div>Enter an expression for evaluation here (press enter to evaluate it):</div>
     <textarea id="expr"></textarea>
    </div>
   </div>
  
   <div id="right">
    <div id="envcontainer">
     <div>This is the current top-level environment:</div>
     <table id="env">
      <tr><th>name</th><th>type</th><th>value</th></tr>
     </table>
    </div>
    
    <div>
     <div>parsed s-expression of last expression:</div>
     <div id="lastsexpr"></div>
     <div>Primitives of last parse:</div>
     <div id="lastprims"></div>
    </div>
   </div>
   
  </div>


 <script type="text/javascript">


function printer(obj) {
  if( obj.type === 'function' ) {
    return '<function>';
  }
  
  if( obj.type === 'specialform' ) {
    return '<specialform>';
  }
  
  if( obj.type === 'nil' ) {
	return '<nil>';
  }
  
  if( obj.type !== 'list' ) {
    return obj.value;
  }

  var q = [];
  for(var i = 0; i < obj.value.length; i++) {
    q.push(printer(obj.value[i]));
  }

  return q;
}


function displayEnv(envi) {
  var tab = $("#env"),
      q, val;
  $("#env .envrow").remove();
  for(q in envi._bindings) {
    val = envi.getBinding(q);
    tab.append('<tr class="envrow"><td>' + q + "</td><td>" + val.type + "</td><td>" + _.escape(printer(val)) + "</td></tr>");
  }
}


 $(document).ready(function() {

  var evaler = new Repl.Evaluator(),
      env = evaler.getEnvironment();

  //$("#runner").click(function(e) { //
  $("#expr").bind('keydown', function(e) {
    var code = (e.keyCode ? e.keyCode : e.which);
    if( code == 13 ) {
      var str = $("#expr").val();
      evaler.evalString(str); // which then runs the lisper, calls listeners ...
      return false;
    }
    return true;
  });

  evaler.bind("success", function(obj) {
    var h = $("#history");
    h.append("<ul>" + _.escape("> " + obj.string) + "</ul>");
    h.append("<ul>" + _.escape(JSON.stringify(printer(obj.result))) + "</ul>");
  });
  
  evaler.bind("success", function(obj) {
        
//    $("#env").text(JSON.stringify(env));
    displayEnv(env);
    $("#lastsexpr").text(JSON.stringify(obj.parsed));
    $("#lastprims").text(JSON.stringify(obj.primitives));
    $("#expr").val("");
  });

  evaler.bind("error", function(obj) {
    $("#history").append("<ul>" + _.escape("> " + obj.string) + "</ul>");
    $("#history").append("<ul>" + "ERROR: " + _.escape(obj.errormessage) + "</ul>");
  });
  
  evaler.bind('all', function() {
    var h = $("#history");
    h.scrollTop(h.prop("scrollHeight"));
  });
  
  // get the page set-up:  show the environment
  displayEnv(env);

 });

</script>

 </body>
</html>